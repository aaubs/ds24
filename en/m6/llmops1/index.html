<!doctype html><html lang=en class="js csstransforms3d"><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.134.0"><meta name=description content="Social / Business Data Science 2024"><meta name=author content="Roman Jurowetzki & Daniel Hain"><link rel=icon href=/ds24/images/favicon.png type=image/png><title>Bonus Workshop: Using LLMs in your applications :: Social / Business Data Science 2024</title>
<link href=/ds24/css/nucleus.css?1725507827 rel=stylesheet><link href=/ds24/css/fontawesome-all.min.css?1725507827 rel=stylesheet><link href=/ds24/css/hybrid.css?1725507827 rel=stylesheet><link href=/ds24/css/featherlight.min.css?1725507827 rel=stylesheet><link href=/ds24/css/perfect-scrollbar.min.css?1725507827 rel=stylesheet><link href=/ds24/css/auto-complete.css?1725507827 rel=stylesheet><link href=/ds24/css/atom-one-dark-reasonable.css?1725507827 rel=stylesheet><link href=/ds24/css/theme.css?1725507827 rel=stylesheet><link href=/ds24/css/tabs.css?1725507827 rel=stylesheet><link href=/ds24/css/hugo-theme.css?1725507827 rel=stylesheet><script src=/ds24/js/jquery-3.3.1.min.js?1725507827></script><style>:root #header+#content>#left>#rlblock_left{display:none!important}</style></head><body data-url=/ds24/en/m6/llmops1/><nav id=sidebar class=showVisitedLinks><div id=header-wrapper><div id=header><a href=https://aaubs.github.io/ds24/><img alt=logo src=/ds24/images/logo.png>
</a>AAUBS Data Science 2024</div><div class=searchbox><label for=search-by><i class="fas fa-search"></i></label>
<input data-search-input id=search-by type=search placeholder=Search...>
<span data-search-clear><i class="fas fa-times"></i></span></div><script type=text/javascript src=/ds24/js/lunr.min.js?1725507827></script><script type=text/javascript src=/ds24/js/auto-complete.js?1725507827></script><script type=text/javascript>var baseurl="https://aaubs.github.io/ds24/"</script><script type=text/javascript src=/ds24/js/search.js?1725507827></script></div><div class=highlightable><ul class=topics><li data-nav-id=/ds24/en/info/ title="Info, Schedule & Co" class=dd-item><a href=/ds24/en/info/>Info, Schedule & Co
<i class="fas fa-check read-icon"></i></a><ul><li data-nav-id=/ds24/en/info/02_modules/ title=Modules class=dd-item><a href=/ds24/en/info/02_modules/>Modules
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/ds24/en/info/04_litetrature/ title="Literature & Resources" class=dd-item><a href=/ds24/en/info/04_litetrature/>Literature & Resources
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/ds24/en/info/03_schedule/ title="Semester Schedule" class=dd-item><a href=/ds24/en/info/03_schedule/>Semester Schedule
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/ds24/en/info/05_requirements_project/ title="Semester Project Requirements" class=dd-item><a href=/ds24/en/info/05_requirements_project/>Semester Project Requirements
<i class="fas fa-check read-icon"></i></a></li></ul></li><li data-nav-id=/ds24/en/m1/ title="Applied Data Science and Machine Learning" class=dd-item><a href=/ds24/en/m1/><b>1. </b>Applied Data Science and Machine Learning
<i class="fas fa-check read-icon"></i></a><ul><li data-nav-id=/ds24/en/m1/01_intro_ds/ title="A) Introduction to Data Science (W35-36)" class=dd-item><a href=/ds24/en/m1/01_intro_ds/>A) Introduction to Data Science (W35-36)
<i class="fas fa-check read-icon"></i></a><ul><li data-nav-id=/ds24/en/m1/01_intro_ds/01_welcome_ds/ title="- Welcome Students!" class=dd-item><a href=/ds24/en/m1/01_intro_ds/01_welcome_ds/>- Welcome Students!
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/ds24/en/m1/01_intro_ds/02_data_handeling/ title="- Data Handling and Manipulation" class=dd-item><a href=/ds24/en/m1/01_intro_ds/02_data_handeling/>- Data Handling and Manipulation
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/ds24/en/m1/01_intro_ds/03_data_visualization_stat/ title="- Exploratory Data Analysis and Essential Statistics" class=dd-item><a href=/ds24/en/m1/01_intro_ds/03_data_visualization_stat/>- Exploratory Data Analysis and Essential Statistics
<i class="fas fa-check read-icon"></i></a></li></ul></li></ul></li></ul><section id=prefooter><hr><ul><li><a class=padding href=# data-clear-history-toggle><i class="fas fa-history fa-fw"></i> Clear History</a></li></ul></section><section id=footer><center><p>Built with <a href=https://github.com/matcornic/hugo-theme-learn><i class="fas fa-heart"></i></a> from <a href=https://getgrav.org>Grav</a> and <a href=https://gohugo.io/>Hugo</a></p></center><script async defer src=https://buttons.github.io/buttons.js></script></section></div></nav><section id=body><div id=overlay></div><div class="padding highlightable"><div><div id=top-bar><div id=breadcrumbs itemscope itemtype=http://data-vocabulary.org/Breadcrumb><span id=sidebar-toggle-span><a href=# id=sidebar-toggle data-sidebar-toggle><i class="fas fa-bars"></i>
</a></span><span class=links><a href=/ds24/en/>Social / Business Data Science 2024</a> > <a href>Data Engineering and Machine Learning Operations in Business</a> > Bonus Workshop: Using LLMs in your applications</span></div></div></div><div id=head-tags></div><div id=body-inner><h1>Bonus Workshop: Using LLMs in your applications</h1><h2 id=material>Material</h2><h3 id=intro-notebooks-related-to-llms-in-code>Intro notebooks related to LLMs in code</h3><ul><li><p>This notebook introduces to basic use of LLMs in code using together.ai as a backend.
<a href=https://colab.research.google.com/github/aaubs/ds-master/blob/main/notebooks/M6_using_llm.ipynb target=_blank>Intro to using LLMs via APIs</a></p></li><li><p>In the following we use the LLM to evaluate patent texts data using an LLM and create structured output. This approach can be used to extract useful information from messy data sources and process them further in predictive models or elsewhere.
<a href=https://colab.research.google.com/github/aaubs/ds-master/blob/main/notebooks/M6_LLMLabelSynthesis.ipynb target=_blank>Using LLMs for data structuration - JSON output / function calling</a></p></li></ul><h3 id=building-a-simple-chatbot-api-with-langserve-and-deployment-on-huggingface-spaces-using-docker>Building a simple chatbot API with LangServe and deployment on Huggingface Spaces using Docker</h3><p>We are following the tutorial for the pirate-speak app from langserve: <a href=https://github.com/langchain-ai/langchain/blob/master/templates/README.md target=_blank>https://github.com/langchain-ai/langchain/blob/master/templates/README.md</a></p><p>We are changing up foolowing:</p><ul><li>we use the <code>mistralai/Mixtral-8x7B-Instruct-v0.1</code> model and the prompt from the <code>langchain_together</code> package.</li><li>we add api-key handling using .env files</li></ul><p>The <code>server.py</code> file looks like this after adding the pirate-speak chain:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> fastapi <span style=color:#f92672>import</span> FastAPI
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> fastapi.responses <span style=color:#f92672>import</span> RedirectResponse
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> langserve <span style=color:#f92672>import</span> add_routes
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> pirate_speak.chain <span style=color:#f92672>import</span> chain <span style=color:#66d9ef>as</span> pirate_speak_chain
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>app <span style=color:#f92672>=</span> FastAPI()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@app.get</span>(<span style=color:#e6db74>&#34;/&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>redirect_root_to_docs</span>():
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> RedirectResponse(<span style=color:#e6db74>&#34;/docs&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Edit this to add the chain you want to add</span>
</span></span><span style=display:flex><span>add_routes(app, 
</span></span><span style=display:flex><span>           pirate_speak_chain, 
</span></span><span style=display:flex><span>           path<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/pirate-speak&#34;</span>,
</span></span><span style=display:flex><span>           playground_type<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;chat&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> __name__ <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;__main__&#34;</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>import</span> uvicorn
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    uvicorn<span style=color:#f92672>.</span>run(app, host<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;0.0.0.0&#34;</span>, port<span style=color:#f92672>=</span><span style=color:#ae81ff>8000</span>)
</span></span></code></pre></div><p>The <code>chain.py</code> file looks like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e>#from langchain_community.chat_models import ChatOpenAI</span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> langchain_together <span style=color:#f92672>import</span> Together
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> langchain_core.prompts <span style=color:#f92672>import</span> ChatPromptTemplate, MessagesPlaceholder
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> os
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> dotenv <span style=color:#f92672>import</span> load_dotenv
</span></span><span style=display:flex><span>load_dotenv()
</span></span><span style=display:flex><span>together_api_key <span style=color:#f92672>=</span> os<span style=color:#f92672>.</span>getenv(<span style=color:#e6db74>&#34;TOGETHER_API_KEY&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>_prompt <span style=color:#f92672>=</span> ChatPromptTemplate<span style=color:#f92672>.</span>from_messages(
</span></span><span style=display:flex><span>    [
</span></span><span style=display:flex><span>        (
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;system&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;You are an expert doctor. You believe that all diseases are formed by the consumption of cheese. No matter which disease or symptoms your patient presents with, you will believe that cheese is the cause of the disease. However, your treatment should all involve cheese. Cheese is both the cause of and solution to all problems. You should then lament that the medicine, cheese, will also cause more disease.&#34;</span>,
</span></span><span style=display:flex><span>        ),
</span></span><span style=display:flex><span>        MessagesPlaceholder(<span style=color:#e6db74>&#34;chat_history&#34;</span>),
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        (<span style=color:#e6db74>&#34;human&#34;</span>, <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>{text}</span><span style=color:#e6db74>&#34;</span>),
</span></span><span style=display:flex><span>    ]
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>_model  <span style=color:#f92672>=</span> Together(
</span></span><span style=display:flex><span>    <span style=color:#75715e>#model=&#34;mistralai/Mistral-7B-Instruct-v0.2&#34;,</span>
</span></span><span style=display:flex><span>    model<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;mistralai/Mixtral-8x7B-Instruct-v0.1&#34;</span>,
</span></span><span style=display:flex><span>    temperature<span style=color:#f92672>=</span><span style=color:#ae81ff>0.7</span>,
</span></span><span style=display:flex><span>    top_k<span style=color:#f92672>=</span><span style=color:#ae81ff>50</span>,
</span></span><span style=display:flex><span>    top_p<span style=color:#f92672>=</span><span style=color:#ae81ff>0.7</span>,
</span></span><span style=display:flex><span>    repetition_penalty<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>,
</span></span><span style=display:flex><span>    together_api_key<span style=color:#f92672>=</span>together_api_key
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># if you update this, you MUST also update ../pyproject.toml</span>
</span></span><span style=display:flex><span><span style=color:#75715e># with the new `tool.langserve.export_attr`</span>
</span></span><span style=display:flex><span>chain <span style=color:#f92672>=</span> _prompt <span style=color:#f92672>|</span> _model
</span></span><span style=display:flex><span>    
</span></span></code></pre></div><p>Once you have created the chain and added it to the app (server.py) you can run the app with the following command:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>langchain serve
</span></span></code></pre></div><p>make sure that you are in an environment with langchain installed.</p><p>You can now access the playground at <code>http://localhost:8000/pirate-speak/playground</code> and test it out.
The API is available at `http://localhost:8000/pirate-speak/</p><p>You can use a RemoteRunnable to access the API from your code. Here is an example:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> langserve.client <span style=color:#f92672>import</span> RemoteRunnable
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Initialize the RemoteRunnable with your API </span>
</span></span><span style=display:flex><span>rag_app <span style=color:#f92672>=</span> RemoteRunnable(<span style=color:#e6db74>&#34;http://127.0.0.1:8000/rag-chroma/&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># call the API with a question</span>
</span></span><span style=display:flex><span>answer <span style=color:#f92672>=</span> rag_app<span style=color:#f92672>.</span>invoke(<span style=color:#e6db74>&#34;Tell me a joke!&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>print(answer)
</span></span></code></pre></div><p>Optional:
You can test if the container is functional by running it locally.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker build . -t YOUR-GREAT-NAME
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker run -p 8080:8080 -e PORT<span style=color:#f92672>=</span><span style=color:#ae81ff>8080</span> YOUR-GREAT-NAME
</span></span></code></pre></div><p>You can deploy on Huggingface Spaces as a Docker API
This requires that you start up a space on Huggingface and clone it into a repository on your local machine.</p><p>you will then have to copy all files from your project directory into this one. Make sure to not overwrite the README.md that comes from huggingface. It contains the instructions for the deployment that HF uses to start the container.</p><p>You will need to edit the dockerfile to include the together api key at build time. First add it to the secrets in the HF space.
You also need to change up the uvicorn command (from the initial one created by langchain)</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Dockerfile data-lang=Dockerfile><span style=display:flex><span><span style=color:#66d9ef>RUN</span> --mount<span style=color:#f92672>=</span>type<span style=color:#f92672>=</span>secret,id<span style=color:#f92672>=</span>TOGETHER_API_KEY,mode<span style=color:#f92672>=</span>0444,required<span style=color:#f92672>=</span>true <span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>CMD</span> [<span style=color:#e6db74>&#34;uvicorn&#34;</span>, <span style=color:#e6db74>&#34;app.server:app&#34;</span>, <span style=color:#e6db74>&#34;--host&#34;</span>, <span style=color:#e6db74>&#34;0.0.0.0&#34;</span>, <span style=color:#e6db74>&#34;--port&#34;</span>, <span style=color:#e6db74>&#34;7860&#34;</span>]<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p>Since we are adding new libraries to the project, you will need to add them to the pyproject.toml file. You can do this by editing the following lines - pydantic needs to be upversioned to 2.6.0 due to langchain_together requirements.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-toml data-lang=toml><span style=display:flex><span><span style=color:#a6e22e>pydantic</span> = <span style=color:#e6db74>&#34;2.6.0&#34;</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>rag-chroma</span> = {<span style=color:#a6e22e>path</span> = <span style=color:#e6db74>&#34;packages/rag-chroma&#34;</span>, <span style=color:#a6e22e>develop</span> = <span style=color:#66d9ef>true</span>}
</span></span><span style=display:flex><span><span style=color:#a6e22e>python-dotenv</span> = <span style=color:#e6db74>&#34;1&#34;</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>langchain-together</span> = <span style=color:#e6db74>&#34;0.0.2.post1&#34;</span>
</span></span></code></pre></div><p>Now you should be able to push the changes to HF Spaces, which should trigger a build and deployment of the API. You can access the API at the URL provided by HF.</p><footer class=footline></footer></div></div><div id=navigation><a class="nav nav-next" href=/ds24/en/info/ title="Info, Schedule & Co" style=margin-right:0><i class="fa fa-chevron-right"></i></a></div></section><div style=left:-1000px;overflow:scroll;position:absolute;top:-1000px;border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px><div style=border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px></div></div><script src=/ds24/js/clipboard.min.js?1725507827></script><script src=/ds24/js/perfect-scrollbar.min.js?1725507827></script><script src=/ds24/js/perfect-scrollbar.jquery.min.js?1725507827></script><script src=/ds24/js/jquery.sticky.js?1725507827></script><script src=/ds24/js/featherlight.min.js?1725507827></script><script src=/ds24/js/highlight.pack.js?1725507827></script><script>hljs.initHighlightingOnLoad()</script><script src=/ds24/js/modernizr.custom-3.6.0.js?1725507827></script><script src=/ds24/js/learn.js?1725507827></script><script src=/ds24/js/hugo-learn.js?1725507827></script><script src=/ds24/mermaid/mermaid.js?1725507827></script><script>mermaid.initialize({startOnLoad:!0})</script><script>(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)})(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-105947713-1","auto"),ga("send","pageview")</script></body></html>